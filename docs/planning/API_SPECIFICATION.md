# üìΩÔ∏è Project Vine - API Specification

**Project Vine** is a modular, agent-compatible, dual-mode video composition system built on top of MoviePy. Designed for AI-driven and human-assisted short-form video generation, it provides an expressive and extensible API, supports scene- and beat-based structures, and is optimized for integration with LLMs and declarative config pipelines.

---

## üéØ Core Design Philosophy

Vine models timelines as composable blocks. Each block (scene, beat, or voice-image pair) can include voice, music, images, clips, effects, and transitions. The framework supports:

- **Scene-based narrative pacing** (e.g. documentaries, sermons)
- **Beat-driven precision editing** (e.g. TikToks, music videos)  
- **Hybrid combinations** (e.g. emotional shorts with rhythmic mid-sections)

Built for automation at scale, it allows:
- Pydantic-validated configs (YAML/JSON)
- Agent-generated inputs
- Global/timeline/block default overrides
- Extensible registries (for transitions, animations, audio FX)

---

## üß± Core API: TimelineBuilder

### Primary Interface

```python
from vine import TimelineBuilder

timeline = (
    TimelineBuilder()  # Defaults: verbose=True, strict_mode=True
    .with_defaults(animation="ken_burns", transition="crossfade")
    .add_music("assets/music/ambient.mp3", bpm=100)
    .add_voice_image_pair("voice/line1.mp3", "images/scene1.jpg")
        .with_animation("ken_burns", zoom="in")
        .with_subtitle("Keep going.")
        .with_transition("fade", duration=1.0)
    .add_voice_image_pair("voice/line2.mp3", "images/scene2.jpg")
        .with_animation("slide_in", direction="left")
        .with_subtitle("Don't stop now.")
    .export("output/final.mp4", resolution="1080x1920")
)
```

### TimelineBuilder Constructor

```python
TimelineBuilder(
    strict_mode=True,    # Fail on missing required values (default)
    verbose=True         # Show warnings for fallbacks (default)
)
```

**Configuration Options:**
- **`strict_mode=True`**: Raises `VineConfigError` when required values are missing
- **`strict_mode=False`**: Uses fallbacks with warnings (for rapid prototyping)
- **`verbose=True`**: Shows helpful warnings about fallback usage
- **`verbose=False`**: Silent fallbacks (for production use)

### TimelineBuilder Methods

| Method | Description | Parameters |
|--------|-------------|------------|
| `.with_defaults(**kwargs)` | Set timeline-level defaults | `animation`, `transition`, `resolution`, `font` |
| `.add_music(path, bpm=None)` | Add background music track | `path: str`, `bpm: Optional[int]` |
| `.add_voiceover(path)` | Add global voiceover track | `path: str` |
| `.add_voice_image_pair(voice, image)` | Add synced voice-image block | `voice: str`, `image: str` |
| `.with_animation(type, **params)` | Set animation for last block | `type: str`, `**params` |
| `.with_subtitle(text)` | Add subtitle overlay | `text: str` |
| `.with_transition(type, **params)` | Add transition to next block | `type: str`, `**params` |
| `.start_scene(name)` | Start story-driven scene block | `name: str` |
| `.start_beat_track(music, bpm)` | Start beat-driven block | `music: str`, `bpm: int` |
| `.on_beat(time).add_clip(...)` | Add beat-aligned elements | `time: float` |
| `.export(path, resolution)` | Render final video | `path: str`, `resolution: str` |
| `.get_defaults()` | Show current default values | None |

---

## üéõÔ∏è Enhanced Defaults System

### Default Hierarchy with Warnings

The system uses a clear hierarchy with intelligent warnings:

```
Block Override > Timeline Default > Global Default > Fallback Value
```

### Global Defaults (Application-wide)

```python
from vine.defaults import set_global_defaults

set_global_defaults(
    animation="ken_burns",
    transition="crossfade", 
    resolution="1080x1920",
    font="Montserrat-Bold"
)
```

### Timeline Defaults (Per-timeline)

```python
timeline = (
    TimelineBuilder()
    .with_defaults(
        animation="slide_in",
        transition="fade",
        resolution="720x1280"
    )
    # All blocks use these defaults unless overridden
)
```

### Block Overrides (Per-block)

```python
.add_voice_image_pair("voice.mp3", "img.jpg")
    .with_animation("zoom_blur")  # Override animation only
    .with_subtitle("Custom text")  # Add subtitle
    # Uses timeline default for transition
```

### Discovering Current Defaults

```python
# Show all current default values
print(TimelineBuilder.get_defaults())
# Output:
# {
#   'animation': 'ken_burns',
#   'transition': 'crossfade',
#   'resolution': '1080x1920',
#   'font': 'Montserrat-Bold'
# }

# Show defaults for a specific timeline
timeline = TimelineBuilder().with_defaults(animation="slide_in")
print(timeline.get_defaults())
# Output:
# {
#   'animation': 'slide_in',
#   'transition': 'crossfade',  # From global
#   'resolution': '1080x1920',  # From global
#   'font': 'Montserrat-Bold'   # From global
# }
```

### Warning Examples

```python
# With verbose=True (default)
timeline = TimelineBuilder()
timeline.add_voice_image_pair("voice.mp3", "image.jpg")
# Warning: "No animation specified, using fallback: static"
# Warning: "No transition specified, using fallback: fade"

# With strict_mode=True (default)
timeline = TimelineBuilder(strict_mode=True)
timeline.add_voice_image_pair("voice.mp3", "image.jpg")
# Raises: VineConfigError("Animation must be explicitly set in strict mode")

# With both relaxed
timeline = TimelineBuilder(strict_mode=False, verbose=False)
timeline.add_voice_image_pair("voice.mp3", "image.jpg")
# Silent fallbacks, no warnings
```

---

## üóÇÔ∏è Registry System

### Animation Registry

```python
from vine.registry import register_animation

@register_animation("ken_burns")
def ken_burns_fx(clip, zoom="in", speed="slow"):
    """Ken Burns effect with zoom and speed control"""
    # Implementation using moviepy
    pass

@register_animation("slide_in") 
def slide_in_fx(clip, direction="left"):
    """Slide in from specified direction"""
    pass

@register_animation("static")
def static_fx(clip):
    """No motion effect"""
    return clip
```

### Transition Registry

```python
from vine.registry import register_transition

@register_transition("fade")
def fade_transition(clip_a, clip_b, duration=1.0):
    """Fade transition between clips"""
    pass

@register_transition("crossfade")
def crossfade_transition(clip_a, clip_b, duration=0.5):
    """Crossfade transition"""
    pass

@register_transition("slide")
def slide_transition(clip_a, clip_b, direction="left", duration=1.0):
    """Slide transition"""
    pass
```

### Registry Access

```python
# Get animation function
animation_fn = ANIMATION_REGISTRY["ken_burns"]
animated_clip = animation_fn(clip, zoom="in", speed="slow")

# Get transition function  
transition_fn = TRANSITION_REGISTRY["fade"]
final_clip = transition_fn(clip_a, clip_b, duration=1.0)
```

---

## üìú Structured Data Models (Pydantic)

### Core Models

```python
from pydantic import BaseModel
from enum import Enum
from typing import Optional, List

class AnimationType(str, Enum):
    ken_burns = "ken_burns"
    slide_in = "slide_in" 
    static = "static"

class AnimationSpec(BaseModel):
    type: AnimationType
    zoom: Optional[str] = None  # "in", "out"
    direction: Optional[str] = None  # "left", "right", "up", "down"
    speed: Optional[str] = None  # "slow", "medium", "fast"

class VoiceImageBlock(BaseModel):
    voice: str  # Path to voice file (MP3)
    image: str  # Path to image file (JPG/PNG)
    subtitle: Optional[str] = None  # Text overlay shown during voice
    animation: Optional[AnimationSpec] = None  # Motion effect on image
    transition: Optional[str] = None  # Transition to next block

class VineSpec(BaseModel):
    defaults: Optional[dict] = {}  # Timeline defaults
    voice_image_pairs: List[VoiceImageBlock]  # Sequence of blocks
```

---

## üìÑ Input Parsers

### From JSON (AI Agent Integration)

```python
from vine.loader import load_vine_from_json

# AI agent generates JSON
json_string = '''
{
  "voice_image_pairs": [
    {
      "voice": "voice/line1.mp3",
      "image": "images/scene1.jpg", 
      "subtitle": "Keep going.",
      "animation": {
        "type": "ken_burns",
        "zoom": "in"
      },
      "transition": "fade"
    }
  ]
}
'''

spec = load_vine_from_json(json_string)
timeline = TimelineBuilder().build_from_spec(spec)
```

### From YAML (Human Editing)

```python
from vine.loader import load_vine_from_yaml

# Human-editable YAML file
spec = load_vine_from_yaml("project.yaml")
timeline = TimelineBuilder().build_from_spec(spec)
```

Example YAML:
```yaml
defaults:
  animation: ken_burns
  transition: crossfade
  resolution: 1080x1920

voice_image_pairs:
  - voice: voice/line1.mp3
    image: images/scene1.jpg
    subtitle: "Keep going."
    animation:
      type: ken_burns
      zoom: in
    transition: fade
```

---

## üß† AI Agent Integration

### Preferred Workflow

1. **Agent generates JSON** matching `VineSpec` schema
2. **Parse with Pydantic** for validation
3. **Build timeline** from validated spec
4. **Export video** with full error handling

### Agent Output Example

```json
{
  "defaults": {
    "animation": "ken_burns",
    "transition": "crossfade"
  },
  "voice_image_pairs": [
    {
      "voice": "voice/line1.mp3",
      "image": "images/scene1.jpg",
      "subtitle": "When it hurts, it means you're growing.",
      "animation": {
        "type": "ken_burns",
        "zoom": "in",
        "speed": "slow"
      },
      "transition": "fade"
    }
  ]
}
```

### Schema Validation

```python
# Agent output validation
try:
    spec = VineSpec.model_validate_json(agent_output)
    timeline = TimelineBuilder().build_from_spec(spec)
    timeline.export("output.mp4")
except ValidationError as e:
    # Handle invalid agent output
    print(f"Agent output validation failed: {e}")
```

---

## üé¨ Scene vs Beat Editing

### Scene-Based Editing (Story-driven)

```python
timeline = (
    TimelineBuilder()
    .start_scene("Opening")
        .add_voiceover("voice/intro.mp3")
        .add_clip("clips/opening.mp4")
        .add_text("It starts here")
        .add_transition("fade", duration=1.0)
    .start_scene("B-roll")
        .add_clip("clips/broll1.mp4")
        .add_clip("clips/broll2.mp4")
        .set_transition("slide", direction="left")
    .export("output/scene_video.mp4")
)
```

### Beat-Driven Editing (Rhythm-driven)

```python
timeline = (
    TimelineBuilder()
    .add_music("music/drive.mp3", bpm=120)
    .sync_to_beats([
        {"time": 0.5, "clip": "clips/step1.mp4"},
        {"time": 1.0, "clip": "clips/step2.mp4"},
        {"time": 1.5, "text": "Keep moving"},
    ])
    .export("output/beat_video.mp4")
)
```

### Hybrid Mode

```python
timeline = (
    TimelineBuilder()
    .start_scene("Opening")
        .add_voiceover("voice/intro.mp3")
        .add_clip("clips/intro.mp4")
        .add_transition("fade", duration=1.0)
    .start_beat_track(music="music/drive.mp3", bpm=120)
        .on_beat(0.5).add_clip("punch1.mp4")
        .on_beat(1.0).add_clip("punch2.mp4")
        .on_beat(1.5).add_text("Stay strong")
        .set_transition("crossfade", duration=0.3)
    .start_scene("Closing")
        .add_clip("clips/outro.mp4")
    .export("output/hybrid_video.mp4")
)
```

---

## üîß Rendering Internals

### Voice-Image Pair Processing

Each `.add_voice_image_pair()` creates:

1. **AudioFileClip** from voice file
2. **ImageClip** with animation effect applied
3. **TextClip** if subtitle provided
4. **CompositeVideoClip** combining all elements
5. **Duration** determined by voice file length

### Transition Handling

- Transitions are attached to the **tail** of each block
- Each block has `transition_to_next` property
- Final block has no transition (ends cleanly)

### Audio Mixing

- Voice tracks are primary audio
- Music track is mixed underneath
- Optional ducking under voice
- All audio synchronized to video timeline

### Export Process

1. **Flatten timeline** into sequential clips
2. **Apply transitions** between clips
3. **Mix audio tracks** (voice + music)
4. **Render to MP4** with specified resolution
5. **Apply final encoding** settings

---

## üìÅ Project Structure

```
vine/                           # Project root
‚îú‚îÄ‚îÄ src/                        # Source code
‚îÇ   ‚îî‚îÄ‚îÄ vine/                   # Main package
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py         # Main package exports
‚îÇ       ‚îú‚îÄ‚îÄ builder/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ timeline_builder.py     # Main TimelineBuilder class
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ block_builders.py       # VoiceImageBlockBuilder, etc.
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ base_builder.py         # Base builder classes
‚îÇ       ‚îú‚îÄ‚îÄ models/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ video_spec.py          # Pydantic models
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ blocks.py              # Block type definitions
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ enums.py               # AnimationType, etc.
‚îÇ       ‚îú‚îÄ‚îÄ registry/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ base.py                # Base Registry class
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ animations.py          # Animation registry
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ transitions.py         # Transition registry
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ effects.py             # Built-in effects
‚îÇ       ‚îú‚îÄ‚îÄ loader/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ json_loader.py         # JSON parsing
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ yaml_loader.py         # YAML parsing
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ spec_builder.py        # Spec-to-timeline conversion
‚îÇ       ‚îú‚îÄ‚îÄ render/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ moviepy_integration.py # MoviePy wrapper
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ audio_processor.py     # Audio mixing
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ exporter.py            # Export pipeline
‚îÇ       ‚îú‚îÄ‚îÄ defaults.py                # Defaults management
‚îÇ       ‚îú‚îÄ‚îÄ api.py                     # High-level API exports
‚îÇ       ‚îî‚îÄ‚îÄ exceptions.py              # Custom exceptions
‚îú‚îÄ‚îÄ tests/                     # Test suite
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_models.py          # Pydantic model tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_registry.py        # Registry system tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_defaults.py        # Defaults management tests
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_builder.py         # TimelineBuilder tests
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_rendering.py       # End-to-end rendering tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_parsing.py         # JSON/YAML parsing tests
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_audio.py           # Audio processing tests
‚îÇ   ‚îú‚îÄ‚îÄ fixtures/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sample_audio/           # Test audio files
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sample_images/          # Test image files
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sample_configs/         # Test YAML/JSON configs
‚îÇ   ‚îî‚îÄ‚îÄ conftest.py                 # Pytest configuration
‚îú‚îÄ‚îÄ examples/                   # Example projects
‚îÇ   ‚îú‚îÄ‚îÄ basic_usage/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ simple_video.py        # Basic voice-image pair
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ with_animations.py     # Animation examples
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ with_transitions.py    # Transition examples
‚îÇ   ‚îú‚îÄ‚îÄ ai_integration/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent_example.py       # AI agent integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ json_specs/            # Sample JSON specs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ yaml_configs/          # Sample YAML configs
‚îÇ   ‚îú‚îÄ‚îÄ advanced_features/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scene_editing.py       # Scene-based editing
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ beat_editing.py        # Beat-driven editing
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hybrid_mode.py         # Hybrid editing
‚îÇ   ‚îî‚îÄ‚îÄ tutorials/
‚îÇ       ‚îú‚îÄ‚îÄ getting_started.py     # Tutorial examples
‚îÇ       ‚îú‚îÄ‚îÄ custom_effects.py      # Custom effect creation
‚îÇ       ‚îî‚îÄ‚îÄ best_practices.py      # Best practices guide
‚îú‚îÄ‚îÄ docs/                        # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ api/                      # API documentation
‚îÇ   ‚îú‚îÄ‚îÄ tutorials/                # Tutorial guides
‚îÇ   ‚îú‚îÄ‚îÄ examples/                 # Code examples
‚îÇ   ‚îî‚îÄ‚îÄ planning/                 # Project planning docs
‚îú‚îÄ‚îÄ scripts/                      # Utility scripts
‚îÇ   ‚îú‚îÄ‚îÄ setup_dev.py              # Development setup
‚îÇ   ‚îú‚îÄ‚îÄ run_tests.py              # Test runner
‚îÇ   ‚îî‚îÄ‚îÄ build_docs.py             # Documentation builder
‚îú‚îÄ‚îÄ .github/                      # GitHub workflows
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ ci.yml                # Continuous integration
‚îÇ       ‚îî‚îÄ‚îÄ release.yml           # Release automation
‚îú‚îÄ‚îÄ requirements/                 # Dependency management
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt          # Production dependencies
‚îÇ   ‚îú‚îÄ‚îÄ requirements-dev.txt      # Development dependencies
‚îÇ   ‚îî‚îÄ‚îÄ requirements-test.txt     # Testing dependencies
‚îú‚îÄ‚îÄ pyproject.toml               # Project configuration
‚îú‚îÄ‚îÄ setup.py                     # Package setup (legacy)
‚îú‚îÄ‚îÄ README.md                    # Project overview
‚îú‚îÄ‚îÄ CHANGELOG.md                 # Version history
‚îú‚îÄ‚îÄ LICENSE                      # License file
‚îî‚îÄ‚îÄ .gitignore                   # Git ignore rules
```

---

## ‚úÖ Feature Checklist

| Feature | Status | Description |
|---------|--------|-------------|
| Voice-synced image blocks | ‚úÖ | Auto-duration from voice files |
| Scene-based editing | ‚úÖ | Story-driven narrative structure |
| Beat-driven blocks | ‚úÖ | Music-synchronized timing |
| Transitions | ‚úÖ | Extensible transition registry |
| Multiple animation types | ‚úÖ | Ken Burns, slide, static, etc. |
| Subtitle overlays | ‚úÖ | Text overlay during voice |
| Enhanced default hierarchy | ‚úÖ | Global ‚Üí Timeline ‚Üí Block with warnings |
| JSON ‚Üí Pydantic pipeline | ‚úÖ | AI agent integration |
| YAML support for humans | ‚úÖ | Human-editable configs |
| Registry system | ‚úÖ | Extensible effects/transitions |
| AI agent compatibility | ‚úÖ | Structured output validation |
| Export to MP4 | ‚úÖ | Resolution and quality control |
| Extensible effects | ‚úÖ | Plugin architecture |
| Intelligent warnings | ‚úÖ | Verbose mode with helpful feedback |
| Strict validation | ‚úÖ | Configurable strict mode for debugging |

---

## üöÄ Getting Started

### Basic Usage

```python
from vine import TimelineBuilder

# Simple voice-image pair (will show warnings for missing defaults)
timeline = (
    TimelineBuilder()  # verbose=True, strict_mode=True by default
    .add_voice_image_pair("voice.mp3", "image.jpg")
        .with_animation("ken_burns", zoom="in")
        .with_subtitle("Hello world")
    .export("output.mp4")
)
```

### With AI Agent

```python
from vine.loader import load_vine_from_json
from vine import TimelineBuilder

# Agent generates JSON
agent_output = ai_agent.generate_video_plan(prompt)

# Parse and build
spec = load_vine_from_json(agent_output)
timeline = TimelineBuilder().build_from_spec(spec)
timeline.export("output.mp4")
```

### With YAML Config

```python
from vine.loader import load_vine_from_yaml
from vine import TimelineBuilder

# Load from YAML file
spec = load_vine_from_yaml("project.yaml")
timeline = TimelineBuilder().build_from_spec(spec)
timeline.export("output.mp4")
```

### Relaxed Mode for Rapid Prototyping

```python
# For quick experimentation
timeline = TimelineBuilder(strict_mode=False, verbose=True)
timeline.add_voice_image_pair("voice.mp3", "image.jpg")
# Shows warnings but continues with fallbacks
```

### Production Mode

```python
# For production use
timeline = TimelineBuilder(strict_mode=False, verbose=False)
timeline.add_voice_image_pair("voice.mp3", "image.jpg")
# Silent fallbacks, no warnings
```

---

This API specification provides a complete foundation for building the Project Vine media composition framework, supporting both human and AI-driven video generation workflows with intelligent defaults and clear feedback. 